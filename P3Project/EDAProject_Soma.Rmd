
EDA of Prosper Loan Data By Ramamohan Soma
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

#if you need to install the packages please uncomment the below.

#install.packages('ggplot2')
#install.packages('dplyr') 
#install.packages('gridExtra')
#install.packages('alr3')
#install.packages('reshape2')
#install.packages('scales')
#install.packages('GGally')
#install.packages('memisc')
#install.packages('RColorBrewer')
#install.packages('plyr')

suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(gridExtra))
suppressMessages(library(alr3))
suppressMessages(library(reshape2))
suppressMessages(library(scales))
suppressMessages(library(GGally))
suppressMessages(library(memisc))
suppressMessages(library(RColorBrewer))
suppressMessages(library(plyr))

```

```{r echo=FALSE, Load_the_Data}
# Load the Data

setwd('C:/nanodegree/DA/EDA/P3Project')

LoanDataAll <- read.csv('prosperLoanData.csv',header = TRUE, check.names = FALSE)

LoanData <- LoanDataAll %>%
  dplyr::select(Term,LoanStatus,BorrowerRate,BorrowerState,Occupation,EmploymentStatus,IsBorrowerHomeowner,CreditScoreRangeLower,CreditScoreRangeUpper,CurrentDelinquencies,AmountDelinquent,IncomeRange,LoanCurrentDaysDelinquent,LoanOriginalAmount,LoanOriginationQuarter,MonthlyLoanPayment,LP_CustomerPayments,LP_CustomerPrincipalPayments,LP_InterestandFees,LP_NetPrincipalLoss)

LoanData$Year <- sub("[[:alnum:]][[:digit:]] ","",LoanData$LoanOriginationQuarter)


dfTemp <- subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))

```

I have chosen the Propser Loan data for this project to explore. There are 113,937 loans (rows) with 81 variables. Below are the names of all the variables.


```{r echo=FALSE, Loan_info}

names(LoanDataAll)

```

Below are the variables from the data I have chosen to analyse and more information on those variables.

```{r echo=FALSE, Loan_info1}

names(LoanData)
str(LoanData)

levels(LoanData$LoanStatus)
levels(LoanData$BorrowerState)
levels(LoanData$EmploymentStatus)
levels(LoanData$IsBorrowerHomeowner)
levels(LoanData$IncomeRange)
levels(LoanData$LoanOriginationQuarter)

```


# Univariate Plots Section


```{r echo=FALSE, Univariate_Plots1}

# Histogrman for LoanOriginalAmount

ggplot(LoanData, aes(x = LoanOriginalAmount)) +
  geom_histogram(binwidth = 400, color = 'black',fill = '#099DD9') +
  scale_x_continuous(breaks = seq(0,40000, 5000),limits = c(0,40000), labels = dollar) +
  xlab('Original Loan Amount (LoanOriginalAmount)') +
  ylab('Number of Cutomers Borrowed (count)') +
  ggtitle('LoanAmounts\n')

```

From the above plots it is evident that for most of the Loan Amonts the number of borrowers are below 7500. Also there is spike in users for the loan amounts around 4,000, 10,000, and 15,000 dollars. Below is the summary of LoanOriginalAmount. Mean in 8337 and Median is 6500.

```{r echo=FALSE, Univariate_Plots1-1}

#Summary and Range of Loan Amount
summary(LoanData$LoanOriginalAmount)
range(LoanData$LoanOriginalAmount)

```

Let's look at the terms of the loans that people were borrowing.

```{r echo=FALSE, Univariate_Plots2}

# Histogrman for Loan Term

ggplot(LoanData, aes(x = Term)) +
  geom_histogram(binwidth = 10, fill = '#099DD9') +
  scale_x_continuous(breaks = seq(0,72, 12),limits = c(0,72)) +
  xlab('Loan Term') +
  ylab('Number of Loans') +
  ggtitle('Loan Terms\n')

# Number of Loans for each Term.
table(LoanDataAll$Term)

```

I see that there are 3 types of Terms (12m, 36m, 60m) and 36months loans are famous(approximately 80% of the loans).

```{r echo=FALSE, Univariate_Plots3}

#ggplot(LoanData, aes(x = BorrowerRate)) +
#  geom_histogram(binwidth = .01, color = 'black', fill = '#099DD9') +
#  scale_x_continuous(breaks = seq(0.04,0.5, 0.01),limits = c(0.04,0.5)) +
#  scale_y_continuous(breaks = seq(0,7000, 200),limits = c(0,7000)) +
#  ggtitle('Loan Rates')

# Histogrman for Borrower Loan Rates

ggplot(LoanData, aes(x = BorrowerRate)) +
  geom_histogram(binwidth = .005, color = 'black', fill = '#099DD9') +
  scale_x_continuous(breaks = seq(0.04,0.5, 0.01),limits = c(0.04,0.5)) +
  scale_y_continuous(breaks = seq(0,7000, 500),limits = c(0,7000)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('Borrower Rate') +
  ylab('Number of Loans') +
  ggtitle('Loan Rates\n')

```

From the above graph on Borrower Rates, Very few loans (4 or 5) are there with 0.4 and above. That's why not visible in the plot. Range is from 0 to 4.975. Median Borrower rate is 0.184. There is spike of count for Borrower rate 0.3177. I'll investigate more on this in BiVariate plots section.

Summary and range of Borrower Rate.

```{r echo=FALSE, Univariate_Plots2-2}

#Summary of BorrowerRate and range.
summary(LoanData$BorrowerRate)
range(LoanData$BorrowerRate)


```

Below is the histogram of LoanOriginalAmount by EmploymentStatus.

```{r echo=FALSE, Univariate_Plots4}

#Histogram of Loan Amounts faceted by Borrower's Employment Status.

ggplot(aes(x = LoanOriginalAmount), data = LoanData) +
  geom_histogram(binwidth = 500, color = 'black', fill = '#099DD9') + 
  scale_x_continuous(breaks = seq(0, 35000, 5000), labels = dollar) +
  scale_y_continuous(breaks = seq(0, 15000, 5000)) +
  coord_cartesian(c(0,35000)) +
  facet_grid(EmploymentStatus~., space = "free_y") +
  xlab('Original Loan Amount (LoanOriginalAmount)') +
  ylab('Number of Cutomers Borrowed (count)') +
  ggtitle('LoanAmounts by EmploymentStatus\n')

```

Above plot depicts that most of the borrowers are Employed and FullTime. Some borrowr types are 'Not available' and 'Other'. Self Employed borrowed less and PartTime/Ritired users did not borrow at all. 


```{r echo=FALSE, Univariate_Plots5}

#Histogram of Loans Status

ggplot(LoanData, aes(x = LoanStatus)) +
  geom_histogram(binwidth = 100, fill = '#099DD9') +
  scale_y_continuous(breaks = seq(0, 60000, 5000)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('Loan Status') +
  ylab('Number of Loans') +
  ggtitle('Status of the Loans Borrowed\n')


```

In the above plot most loans are either completed or current or chargedoff(~10%). There are approximately 5% defaulted loans.Below is info on each loan status.


```{r echo=FALSE, Univariate_Plots4-1}

# Summary of each Loan Status
summary(LoanData$LoanStatus)

```

I would like to see howmany loans have been Delinquent. Below is the plot for current Delinquencies of the loans.

```{r echo=FALSE, Univariate_Plots6}

#ggplot(subset(LoanData, LoanData$CurrentDelinquencies > 0), aes(x = CurrentDelinquencies)) +
#  geom_histogram(binwidth = 1, fill = '#099DD9',alpha=0.5) +
#  scale_x_continuous(breaks = seq(1, 83, 1))

#Frequency Polygon for CurrentDeliquencies

ggplot(subset(LoanData, 
              LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies)),
       aes(x = CurrentDelinquencies)) +
  geom_freqpoly(binwidth = 1) +
  scale_x_continuous(breaks = seq(1, 83, 3)) +
  scale_y_continuous(breaks = c(1,3000,6000,9000,12000)) +
  xlab('Current Deliquencies') +
  ylab('Number of Loans') +
  ggtitle('Borrowers Deliquencies\n')

```


I see that ~12000 customers with 1 Deliquency. Interestingly numberof cusotmers decreased with the increase in Deliquency count. But still total number of Deliquencies is 67,044 which is high. Range is from 1 to 83. Not sure why so many Deliquencies even though loans were issued based on credit score.

Below is the Summary of CurrentDelinquencies with value > 0.

```{r echo=FALSE, Univariate_Plots6-1}

#summary(LoanData$CurrentDelinquencies)
#table(LoanData$CurrentDelinquencies)
#sum(LoanData$CurrentDelinquencies,na.rm=TRUE)

#Information on deliquencies whose value is greater than 0.

summary(subset(LoanData,LoanData$CurrentDelinquencies>0 & !is.na(CurrentDelinquencies))$CurrentDelinquencies)

table(subset(LoanData,LoanData$CurrentDelinquencies>0 & !is.na(CurrentDelinquencies))$CurrentDelinquencies)

sum(subset(LoanData,LoanData$CurrentDelinquencies>0 & !is.na(CurrentDelinquencies))$CurrentDelinquencies)

```

I want to look at the principal Loss of the loans to the investors. Below is the plot using the variable LP_NetPrincipalLoss which means the principal remains uncollected after any recoveries.

```{r echo=FALSE, Univariate_Plots7}

#ggplot(LoanData, aes(x = LP_CustomerPayments)) +
#  geom_histogram(binwidth = 500,color = 'black',fill = '#099DD9') +
#  scale_x_continuous(breaks = seq(0, 35000, 1000)) +

# Histogram of Loan Net Principal Loss whose value is > 0.

ggplot(subset(LoanData, 
              LoanData$LP_NetPrincipalLoss > 0),
       aes(x = LP_NetPrincipalLoss)) +
  geom_histogram(binwidth = 100,color = 'black',fill = '#099DD9') +
  scale_x_continuous(labels = dollar) +
  xlab('Net Principal Loss (LP_NetPrincipalLoss)') +
  ylab('Number of Loans with Principal Loss (count)') +
  ggtitle('Loss of princial Amount on the Loans Issued\n')


#summary(subset(LoanData,LoanData$LP_NetPrincipalLoss>0)$LP_NetPrincipalLoss)

```

Above plot is made with the values of 'LP_NetPrincipalLoss' > 0. Most of the Principal Loss is under $5000. There are loans with Principal Loss between $5000 and $15000. NUmber of Loans with Principal Loss between $1500 to $25000 is much less compared to others. 

Summary of 'LP_NetPrincipalLoss' > 0:

```{r echo=FALSE, Univariate_Plots7-1}

#Information on LP_NetPrincipalLos whose value is greater than 0.

summary(subset(LoanData,LoanData$LP_NetPrincipalLoss>0)$LP_NetPrincipalLoss)

```


I have observed that there are some loans with 'LP_NetPrincipalLoss' < 0 which means it's a Principal Profit exculding Interest and Fees. Below is the plot. 


```{r echo=FALSE, Univariate_Plots8}

# Histogram of Loan Net Principal Loss whose value is < 0 which means
# it's a profit.

ggplot(subset(LoanData, 
              LoanData$LP_NetPrincipalLoss < 0),
       aes(x = LP_NetPrincipalLoss)) +
  geom_histogram(binwidth = 100,color = 'black',fill = 'orange') +
  scale_x_continuous(labels = dollar) +
  xlab('Net Principal Gain (LP_NetPrincipalLoss < 0)') +
  ylab('Number of Loans with Principal Gain (count)') +
  ggtitle('Gain of princial Amount on the Loans Issued\n')

```

Summary of 'LP_NetPrincipalLoss' < 0:

```{r echo=FALSE, Univariate_Plots8-1}

#Information on LP_NetPrincipalLos whose value is less than 0.
summary(subset(LoanData,LoanData$LP_NetPrincipalLoss<0)$LP_NetPrincipalLoss)
```

Now let's look at the Income Range of the People who has borrowed loans and also if they are Homeowners or not.

```{r echo=FALSE, Univariate_Plots9}

#ggplot(LoanData, aes(x = IncomeRange)) +
#  geom_histogram(binwidth = 50, color = 'black', fill = '#099DD9') +
#  xlab('Income Range') +
#  ylab('Number of Loans(count)') +
#  ggtitle('Income Range of the Borrowers')

# Bar plot of Income Range, fill with IsBorrowerHomeowner

ggplot(LoanData, mapping = aes(x = IncomeRange)) +
  layer(geom = "bar", mapping = aes(fill = IsBorrowerHomeowner)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('Income Range') +
  ylab('Number of Loans(count)') +
  ggtitle('Income Range of the Borrowers\n')

```

Income Range of the most Borrowers is in the middle ($25k to $75k) and many of them are not homeowners. Aslo with mostly 36 month loans as per the data.Surprisingly there are loans with zero Income Range of. Does that mean Borowers without income can get loans?

```{r echo=FALSE, Univariate_Plots9-1}
# Summary of Income Range.

summary(LoanData$IncomeRange)

```


# Univariate Analysis

### What is the structure of your dataset?

There are 113,937 loans in the Data set and 81 features. I have selected the below 17 features.

Term, LoanStatus, BorrowerState, EmploymentStatus, IsBorrowerHomeowner, LoanOriginationQuarter

BorrowerRate,CurrentDelinquencies,AmountDelinquent,IncomeRange,LoanCurrentDaysDelinquent,LoanOriginalAmount, MonthlyLoanPayment, LP_CustomerPayments, LP_CustomerPrincipalPayments, LP_InterestandFees, LP_NetPrincipalLoss

Minimum LoanAmount Borrowed is $1,000 and Maximum is $35,000. There are 3 Loan Terms (12 months, 36 months, 60 months). 36 Months loans are popular. Median Borrower rate is 18%(0.18). Employed and FullTime are the main Borrowers category who most took loans. Most of the Loans are either Current or Completed or ChargedOff. There are approximately 12,000 borrowers with 1 CurrentDeliquency and there total 67,044 current deliquencies which is high. There are 697 Current Deliquencies with 'NA'. The Median LP_NetPrincipalLoss(The principal that remains uncollected after any recoveries) is $3265. Income Range of the most Borrowers is from $25,000 to $75,000.


### What is/are the main feature(s) of interest in your dataset?

I am interested in many features from the data set but I have isolated to investigate the below features which tells about the Loan Amounts borrowed, Loan rates, Deliquencies etc.

BorrowerRate,CurrentDelinquencies,AmountDelinquent,IncomeRange,LoanCurrentDaysDelinquent,LoanOriginalAmount, MonthlyLoanPayment, LP_CustomerPayments, LP_CustomerPrincipalPayments, LP_InterestandFees, LP_NetPrincipalLoss

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

I think Year of the loan would be helpful to see how many Loans were issued in each year, how many Current Deliquencies per year and how many Net Principal losses per year.

### Did you create any new variables from existing variables in the dataset?

I am planning to create a new variable 'year' in which the loan was borrowed.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?



# Bivariate Plots Section

First I want to explore the relationship between the LoanOriginalAmount and the CurrentDeliquencies.


```{r echo=FALSE, Bivariate_Plots1}

# Scatter plot of LoanOriginalAmount vs CurrentDelinquencies. Limit the
# x scale to 40,000 with breaks of 5000.

ggplot(aes(x = LoanOriginalAmount, y = CurrentDelinquencies), 
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_jitter(alpha=1/10,position=position_jitter(h=0),color='red') +
  scale_x_continuous(breaks = seq(0,40000, 5000),limits = c(0,40000), labels = dollar) +
  ggtitle("Delinquencies by Loan Amount\n")

# Pearson correlation test on LoanOrignalAmount and CurrentDelinquencies.

cor.test(LoanData$LoanOriginalAmount,LoanData$CurrentDelinquencies,method='pearson')

```

From the plot it seems LoanAmounts under $10,000 has many deliquencies. We can see straight lines in the plot for $10,000, $15,000, $20,000 and $25,000 which indicates there are deliquencies even for big amounts. Don't see a good correlation between these two paramters. Correlation value is -0.1721394.

Let's look at the CurrentDeliquencies versus Term Relationship to see which Term loans have more delinquencies.


```{r echo=FALSE, Bivariate_Plots2}

#Scatter Plot between Term and CurrentDelinquencies with values >0 and excluding NA's.
ggplot(aes(x = Term, y = CurrentDelinquencies), 
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_point() +
  scale_y_continuous(breaks = seq(1, 83, 3)) +
  ggtitle("Delinquencies by Term\n")

#cor.test(LoanData$Term,LoanData$CurrentDelinquencies,method='pearson')

cor.test(dfTemp$Term,dfTemp$CurrentDelinquencies,method='pearson')

```

PLot depicts that Delinquencies are more for 36 months Term Loans than other Terms. Correlation Value is -0.0838 and the value without zero's and 'NA's is -0.0996.

Now I would like see how the number of Deliquencies varies by Income Range.

```{r echo=FALSE, Bivariate_Plots3}

# Box plot of IncomeRange vs CurrentDelinquencies > 0 with fill as
# IncomeRange. Limit the deliquencies to 83 with a break of 2.

ggplot(aes(x = IncomeRange,
           y = CurrentDelinquencies,
           fill=IncomeRange), 
       data = subset(LoanData,
                     LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(limits = c(1,83),breaks = seq(1,83,2)) +
  ylab('CurrentDelinquencies') +
  xlab('Income Range of Borrowers(IncomeRange)') +
  ggtitle("Number of Current Delinquencies by Borrower Income Range\n")

```

Below is the details of CurrentDeliquencies for each Income Range.

```{r echo=FALSE, Bivariate_Plots3-1}

# Summary of CurrentDelinquencies based on IncomeRange
by(dfTemp$CurrentDelinquencies,dfTemp$IncomeRange,summary)

```

Meadian and Min Value of CurrentDeliquencies for Income Ranges $1-24,999, $25,000-49,999,$50,000-74,999, $75,000-99,999, $100,000+ and Not Employed are same and it's 1. Median value for Borrowers with Income $0 is 2.Surprisingly for Borrowers whose Income Range is Not Displayed is 3 and Maximum is 82.   Maximum for below Mid Range Income($25,000-49) is 83.




```{r echo=FALSE, Bivariate_Plots4}

# Box plot of EmploymentStatus vs CurrentDelinquencies > 0 with fill as
# EmploymentStatus. Limit the deliquencies to 83 with a break of 2.

ggplot(aes(x = EmploymentStatus,
           y = CurrentDelinquencies,
           fill=EmploymentStatus), 
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(limits = c(1,83),breaks = seq(1,83,2)) +
  ylab('CurrentDelinquencies') +
  xlab('Borrowers Employment Status(EmploymentStatus)') +
  ggtitle("Current Delinquencies by Borrower's Employment Status\n")



```

Below is the details of CurrentDelinquencies for each Employment Status.

```{r echo=FALSE, Bivariate_Plots4-1}

# Summary of CurrentDelinquencies based on EmploymentStatus
by(dfTemp$CurrentDelinquencies,dfTemp$EmploymentStatus,summary)

```


Full Time Employed Borrowers have a median of 2 and Maximum of 83. There is a group of Borrowers whose employment status is 'Not Available'. Median for them is 3 and Maximum is 82 which is pretty high. There are many Borrowers whose Employment Status is blank and they have a median of 3 and Maximum of 57.

Now Lets see how the number of CurrentDelinquencies varies by Year.

```{r echo=FALSE, Bivariate_Plots5}

# Box plot of CurrentDelinquencies > 0 per year with fill as
# Year. 

ggplot(aes(x = Year, y = CurrentDelinquencies),
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_boxplot(aes(fill = Year)) +
  ylab('CurrentDelinquencies') +
  xlab('Year') +
  ggtitle('CurrentDelinquencies by Year\n')

```

Below is the number of CurrentDelinquencies per year.

```{r echo=FALSE, Bivariate_Plots5-1}

# Sum of Deliquencies per year
by(dfTemp$CurrentDelinquencies,dfTemp$Year,sum)

```

Number of CurrentDelinquencies were high in 2006 and 2007. There's a decrease in the count significantly in 2009 but again picked up in later years. 

Lets look at the relationship between LoanOriginalAmount and MonthlyLoanPayment.

```{r echo=FALSE, Bivariate_Plots6}

# Scatter Plot between LoanOriginalAmount and MonthlyLoanPayment. 
# due to overplotting used the 'alpha' parameter in the gemo_point 
# and introduced some jitter.

ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), 
       data = LoanData) +
  geom_point(alpha=1/4,size = 1, position = 'jitter') +
  geom_smooth(method='lm',color='red') +
  xlab('LoanOriginalAmount') +
  ylab('MonthlyLoanPayment') +
  ggtitle('Loan Amount by Monthly Payment\n')

#Pearson Correlation test on LoanOriginalAmount and MonthlyLoanPayment
cor.test(LoanData$LoanOriginalAmount,
         LoanData$MonthlyLoanPayment,
         method='pearson')

```

There is a strong correlation between LoanOriginalAmount and MonthlyLoanPayment and the value is 0.932(rounded). It might be that as the Monthy Payment increases as Loan Amount increases. I see a line where there is steep increse in monthly payments as Loan Amount increases. It could be that BorrowerRate might also affect the relationship.

```{r echo=FALSE, Bivariate_Plots7}

# Box plot of IsBorrowerHomeowner vs LoanOriginalAmount with fill
# as IsBorrowerHomeowner. Limit the scale for LoanOriginalAmount to
# $35000 with breaks of $5000

ggplot(aes(x = IsBorrowerHomeowner,
           y = LoanOriginalAmount,
           fill=IsBorrowerHomeowner ), 
       data = LoanData) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0,35000),
                     breaks = seq(0,35000,5000),
                     labels=dollar) +
  ylab('Original Loan Amount (LoanOriginalAmount)') +
  xlab('Is Borrower Homeowner') +
  ggtitle("LoanAmount by IsBorrowerHomeowner\n")

# Summary of Loan Amounts and Number of Loans
# for Homeowners and Non Homeowners.

by(LoanData$LoanOriginalAmount,LoanData$IsBorrowerHomeowner,summary)
summary(LoanData$IsBorrowerHomeowner)

```

In the above box plot, y-axis is limited to $35000 with breaks of $5000 to take a closer look.Then the statistics(Median,1st Quartuile,3rd Quartile) from 'by' command were matching the Box plots for Homeowners and Non Homeowners. Median, Mean and 3rd Quartile values are more for Homeowners which they are borrowing more money than non Homeowners. A little bit more than half of the borrowers are homeowners.

In the UniVariate Plot on BorrowerRate, I saw a spike for the rate of 0.3177. I want to explore more on this. Below is the plot on BorrowerRate based on EmploymentStatus.

```{r echo=FALSE, Bivariate_Plots8}

#Bar plot with x = BorrowerRate and fill as  EmploymentStatus. Adjusted the x-axis 0.3 to 0.4 to closely look at the spike for rate 0.3177.

ggplot(LoanData, mapping = aes(x = BorrowerRate)) +
  layer(geom = "bar", 
        mapping = aes(fill = EmploymentStatus),
        stat = "bin",
        position="stack",
        stat_params = list(binwidth = 0.001)) +
  scale_x_continuous(breaks = seq(0.3,0.4, 0.01),limits = c(0.3,0.4)) +
  scale_y_continuous(breaks = seq(0,7000, 1000),limits = c(0,7000)) +
  xlab('Borrower Rate') +
  ylab('Number of Loans(count)') +
  ggtitle('Number of Loans by Borrower Rate\n')

```

I see that Many Employed Borrowers got this rate. I see some 'other' and 'SelfEmployed' borrowers also have this rate.

Let's see which income range borrowers has this rate. Below is the plot on BorrowerRate based on IncomeRange.

```{r  echo=FALSE, Bivariate_Plots9}

#Bar plot with x = BorrowerRate and fill as  IncomeRange. Adjusted the x-axis 0.3 to 0.4 to closely look at the spike for rate 0.3177.

ggplot(LoanData, mapping = aes(x = BorrowerRate,fill = IncomeRange)) +
  layer(geom = "bar", 
        stat = "bin",
        position="stack",
        stat_params = list(binwidth = 0.001)) +
  scale_x_continuous(breaks = seq(0.3,0.4, 0.01),limits = c(0.3,0.4)) +
  scale_y_continuous(breaks = seq(0,7000, 1000),limits = c(0,7000)) +
  xlab('Borrower Rate') +
  ylab('Number of Loans(count)') +
  ggtitle('Number of Loans by Borrower Rate\n')

```

I see that except Income range of $0 and 'Not Displayed' all other Income Ranges borrowers have the rate 0.3177.

Let's see the behaviour of LP_NetPrincipalLoss(The principal that remains uncollected after any recoveries.) against the LoanOriginalAmount.

```{r echo=FALSE, Bivariate_Plots10}

# Scatter plot of LP_NetPrincipalLoss vs LoanOriginalAmount.
# For overplotting used alpha=1/10 in geom_point().

LoanDataPL <- subset(LoanData,LoanData$LP_NetPrincipalLoss>0)

ggplot(aes(x = LP_NetPrincipalLoss, y = LoanOriginalAmount), 
       data = LoanDataPL) +
  geom_point(alpha=1/10,size = 3, position = 'jitter', color="blue") +
  ggtitle('LP_NetPrincipalLoss vs LoanOriginalAmount\n') +
  xlab('LP_NetPrincipalLoss') +
  ylab('LoanOriginalAmount') +
  ggtitle('LP_NetPrincipalLoss vs LoanOriginalAmount\n')

# Scatter plot of LP_NetPrincipalLoss vs log10(LoanOriginalAmount).
# For overplotting used alpha=1/10 in geom_point().

ggplot(aes(x = LP_NetPrincipalLoss, y = LoanOriginalAmount), 
       data = LoanDataPL) +
  geom_point(alpha=1/10,size = 3, position = 'jitter', color="blue") +
  coord_trans(y = 'log10') +
  xlab('LP_NetPrincipalLoss') +
  ylab('log10(LoanOriginalAmount)') +
  ggtitle('LP_NetPrincipalLoss vs log10(LoanOriginalAmount)\n')

# Pearson Correlation test on LoanOriginalAmount and LP_NetPrincipalLoss
cor.test(LoanDataPL$LoanOriginalAmount,
         LoanDataPL$LP_NetPrincipalLoss,
         method='pearson')


```

I see a good correlation value of 0.889 between LP_NetPrincipalLoss and LoanOriginalAmount. LP_NetPrincipalLoss is high for Larger Loans.

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

- Relationship between LoanOrinalAmount and CurrentDeliquencies is not linear. Most of the current deliquencies are for Loan Amounts under $10,000. Ofcourse deliquencies do exists for higher Loan amounts from $15,000 to $35,000.
- Most of the Loans issued are 36 months Term and even the number of Deliquencies is high for these loans.
- Mid income range borowers have most deliquencies but surprisingly borrowers whose income range is not displayed also have a maximum of 82 deliquencies.
- Similary borrowers whose Employment Status is not displayed have signigicant deliquencies.
- There is a strong correlation between Monthly Loan Payment and the Loan Amount which should be and borrowers who are home owners have more Loans.
- Relationship between LoanOriginalAmount and LP_NetPrincipalLoss is also very strong.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

Yes! I did observe when I plotted the box plot between Year of the Loan originated and CurrentDeliquencies. There was sudden drop in the year 2009. On more investigation I found that in 2009 there was a relaunch of prosper and implemented stricter guide lines which caused the default rate significantly reduced.

### What was the strongest relationship you found?

The stronges relationships I found was between LoanoriginalAmount and MonthlyPayment, LoanOriginalAmount and LP_NetPrincipalLoss.


# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots-1}

#Scatter Plot for year vs CurrentDelinquencies color by IncomeRange.
ggplot(aes(x = Year, y = CurrentDelinquencies,color=IncomeRange),
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_jitter(size = 2) +
  scale_color_brewer(type = 'qual') +
  theme_minimal() +
  xlab('Year') +
  ylab('CurrentDelinquencies') +
  ggtitle('Number of delinquences per year By Income Range\n')

# Sum of CurrentDelinquencies by Year
by(dfTemp$CurrentDelinquencies,dfTemp$Year,sum)

# Sum of CurrentDelinquencies by IncomeRange
by(dfTemp$CurrentDelinquencies,dfTemp$IncomeRange,sum)

```

From the plot we can that in 2006 all of the deliquencies were from the borrowers with income range "Not displayed". We also the drop of number of deliquencies in 2009. Now let's see the same based on Home owner type.

```{r echo=FALSE, Multivariate_Plots-2}

# Scatter Plot for year vs CurrentDelinquencies color by Borrower Type.
ggplot(aes(x = Year, y = CurrentDelinquencies,color=IsBorrowerHomeowner),
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_jitter(size = 2) +
  scale_color_brewer(palette="Set1") +
  theme_minimal() +
  xlab('Year') +
  ylab('CurrentDelinquencies') +
  ggtitle('Number of delinquences per year By Borrower Type\n')

# Sum of CurrentDelinquencies by IsBorrowerHomeowner
by(dfTemp$CurrentDelinquencies,dfTemp$IsBorrowerHomeowner,sum)

```

Here in the above plot we can see that Non Home owner borrowers deliquencies are more than Home owner borrowers deliquencies in the years 2006 - 2008.

```{r echo=FALSE, Multivariate_Plots-3}

# Scatter Plot for year vs LoanOriginalAmount color by IncomeRange.
ggplot(aes(x = Year, y = LoanOriginalAmount,color=IncomeRange),
       data = LoanData) +
  geom_jitter(size = 3) +
  scale_y_continuous(breaks = seq(0,40000, 5000),limits = c(0,40000)) +
  scale_color_brewer(type = 'qual') +
  theme_minimal() +
  xlab('Year') +
  ylab('LoanOriginalAmount') +
  ggtitle('Loans Issued per year By Income range\n')

```

Surprisingly all the loans from 2006 were of the Borrowers whose income range is "Not displayed". In the later years we can see a mix of borrowers with differnt Income ranges. In 2013 and 2014 there are many borrowers with income range above $100,000.


```{r echo=FALSE, Multivariate_Plots-4}

# Scatter PLot of CurrentDelinquencies vs LoanOriginalAmount 
# color by EmploymentStatus

ggplot(aes(x = CurrentDelinquencies, y = LoanOriginalAmount, color = EmploymentStatus),
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_jitter(size = 5) +
  scale_y_continuous(breaks = seq(0,40000, 5000),limits = c(0,40000)) +
  theme_minimal() +
  xlab('CurrentDelinquencies') +
  ylab('LoanOriginalAmount') +
  ggtitle('CurrentDelinquencies vs LoanOriginalAmount \n by EmploymentStatus\n')

# Sum of CurrentDelinquencies by EmploymentStatus

by(dfTemp$CurrentDelinquencies,dfTemp$EmploymentStatus,sum)

```

Above plot depicts that 85% of delinquent borrowers are Employed, Full-Time and Not available status.


```{r echo=FALSE, Multivariate_Plots-5}

# PLot of CurrentDelinquencies vs LoanOriginalAmount color by IncomeRange
ggplot(aes(x = CurrentDelinquencies, y = LoanOriginalAmount, color = IncomeRange),
       data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies))) +
  geom_jitter(size = 8) +
  scale_y_log10() +
  scale_color_brewer(type = 'qual') +
  theme_minimal() +
  xlab('CurrentDelinquencies') +
  ylab('LoanOriginalAmount') +
  ggtitle('CurrentDelinquencies vs LoanOriginalAmount \n by IncomeRange\n')


```

In the above plot, most of the borrowers whose Income Range is 'Not displayed' have deliquencies with Loan Amounts below $10,000. Deliquencies with high Loan Amounts are from borrowers with Income Range $100,000+.

```{r echo=FALSE, Multivariate_Plots-6}

#Plot of LoanOriginalAmount fill by IncomeRange and facet wrap with Employment Status.
ggplot(aes(x = LoanOriginalAmount, fill = IncomeRange),
       data = LoanData) +
  geom_histogram(binwidth=500) +
  facet_wrap(~ EmploymentStatus) +
  scale_x_continuous(breaks = seq(0,20000, 5000),limits = c(0,20000)) +
  scale_y_continuous(breaks = seq(0,8000, 2000),limits = c(0,8000)) +
  ylab("Count") +
  ggtitle("Loan counts for each of the Borrower's Employed Status\n")


```

Here in the above plot we can see Eomloyed and Full-time borrowers with income ranges from $1-$24,999 to $10,000+ are issued more Loans.

```{r echo=FALSE, Multivariate_Plots-7}

# Create a new data frame "LoanData.ld_by_CreditScoreRangeUpper_IsBorrowerHomeowner"
# the following variables in this order group by CreditScoreRangeUpper,IsBorrowerHomeowner and arrange by CreditScoreRangeUpper
# 1) CreditScoreRangeUpper
# 2) IsBorrowerHomeowner
# 3) mean_Loan_Amount
# 4) median_Loan_Amount
# 5) n
  
LoanData.ld_by_CreditScoreRangeUpper_IsBorrowerHomeowner <- LoanData %>%
  dplyr::group_by(CreditScoreRangeUpper,IsBorrowerHomeowner) %>%
  dplyr::summarise(mean_Loan_Amount=mean(LoanOriginalAmount),
                   median_Loan_Amount=median(as.numeric(LoanOriginalAmount)),
                   n =n()) %>%
  dplyr::ungroup() %>%
  arrange(CreditScoreRangeUpper)

#head(LoanData.ld_by_CreditScoreRangeUpper_IsBorrowerHomeowner)

#Line Plot between CreditScoreRangeUpper and mean_Loan_Amount color with IsBorrowerHomeowner
ggplot(aes(x = CreditScoreRangeUpper, y = mean_Loan_Amount),
       data = LoanData.ld_by_CreditScoreRangeUpper_IsBorrowerHomeowner) +
  geom_line(aes(color=IsBorrowerHomeowner)) +
  xlab("\nCreditScoreRangeUpper") +
  ylab("Mean LoanorignalAmount\n") +
  ggtitle("Mean Loan Amount vs CreditScoreRangeUpper 
          by IsBorrowerHomeowner\n")


```

In the above plot Mean Loan Amout increases as Credit Score increases for Non Home owners but for Home owners there is a fall  in the Mean Loan Amounts for the credit scores more than 800.

Now lets see the correlation coefficients for the below pairs using sampling data.
CreditScoreRangeUpper vs LoanOriginalAmount
LoanOriginalAmount vs MonthlyLoanPayment


```{r echo=FALSE, Multivariate_Plots-8}

theme_set(theme_minimal(10))

#Plots using ggpairs for CreditScoreRangeUpper vs LoanOriginalAmount with sampling data of 10000

ld_subset1 <- LoanData[,c(9,14)]
#names(ld_subset1)
gg1 <- ggpairs(ld_subset1[sample.int(nrow(ld_subset1),10000), ])
suppressWarnings(print(gg1))

#Plots using ggpairs for LoanOriginalAmount vs MonthlyLoanPayment with sampling data of 10000

ld_subset2 <- LoanData[,c(14,16)]
#names(ld_subset2)
ggpairs(ld_subset2[sample.int(nrow(ld_subset2),10000), ])



```

In the above plots, correlation co-efficient is high between LoanOriginalAmount and MonthlyLoanPayment.


```{r echo=FALSE, Multivariate_Plots-9}

# Scatter plot of CurrentDelinquencies vs CreditScoreRangeUpper
# facet wrap with IsBorrowerHomeowner

ggplot(data = subset(LoanData,
                     LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies)), 
       aes(x = CreditScoreRangeUpper, 
           y = CurrentDelinquencies, 
           color = IncomeRange)) +
  geom_jitter(size=3) +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~ IsBorrowerHomeowner) +
  scale_color_brewer(type = 'div') +
  ggtitle("CreditScoreRangeUpper vs CurrentDelinquencies 
           faceted by IsBorrowerHomeowner\n")

```

In the above plot most of the Borrowers with deliquencies if Homeowner or Non Homeowner, fall under credit score range of 400 to 700. Some Non Homeowner borrowers with high deliquencies have credit score of appx 500.

I want to build a linear model to predict the Loan Amount. I am using the varibales LoanOriginalAmount, MonthlyLoanPayment, EmploymentStatus, CreditScoreRangeUpper and IncomeRange

```{r echo=FALSE, Multivariate_Plots-10}
# Build a model using the varibales LoanOriginalAmount, MonthlyLoanPayment, 
# EmploymentStatus, CreditScoreRangeUpper and IncomeRange

m1 <- lm(I(log(LoanOriginalAmount)) ~ I(MonthlyLoanPayment^(1/3)), data = LoanData)
m2 <- update(m1, ~ . + MonthlyLoanPayment)
m3 <- update(m2, ~ . + EmploymentStatus)
m4 <- update(m3, ~ . + CreditScoreRangeUpper)
m5 <- update(m4, ~ . + IncomeRange)
mtable(m1, m2, m3, m4, m5)

```

The variables in this model can account for 85% of variance in the Loan Amount issued to Borrower.


# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

After introducing "Year" and "CreditSCoreRangeUpper", it strengthened my other features of interest and I could see more details from the plots. 
Surprisingly in the Year 2006 most of the deliqeuncies were from borrowers whose Income range was "Not displayed". May it was because Prosper formed that year and guide lines might not be stricter. In 2009 number of deliquencies dropped significantly as the guide lines were made stricter. Employed and FullTime borrowers had more delinquencies as they have more loans compared to other borrowers. Non Homeowners have more deliquencies. Borrowers with high credit scores have loans with lower interest rates.


### Were there any interesting or surprising interactions between features?

I did a further investigation by taking the mean of "LoanOrignalAmount" and plotting against "CreditSCoreRangeUpper". I found that for Non Homeowners Loan Amount increased by credit score but for Homeowners I see a drop in the LoanAmount for the credit scores more than 800.


### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

I created a Model using the varibales log10 of LoanOriginalAmount, cube root of MonthlyLoanPayment, EmploymentStatus, CreditScoreRangeUpper and IncomeRange and found that this model can account for 85% of variance in the Loan Amount issued to Borrower.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

# Box Plot of LP_NetPrincipalLoss per year based on Income Range.

ggplot(aes(x = Year, y = LP_NetPrincipalLoss ), 
       data = subset(LoanData,LoanData$LP_NetPrincipalLoss > 0)) +
  geom_boxplot(aes(fill = IncomeRange)) + 
  ylab('LP_NetPrincipalLoss') +
  xlab('year') +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle('Net principal Loss per year\n')

# Density plot of LP_NetPrincipalLoss

ggplot(data=subset(LoanData,LoanData$LP_NetPrincipalLoss > 0),
       aes(x=LP_NetPrincipalLoss)) +
  geom_density(aes(group=Year,color=Year),alpha=0.30) +
  facet_wrap(~Year, ncol=3, 
               scales = "free") +
  xlab('LP_NetPrincipalLoss') +
  ylab('Density') +
  ggtitle('Density Plot of Net Principal Loss\n')
  


```

### Description One

Median Net principal loss has increased in the year 2007 then decreased and was low in 2009 when prosper implemented strict guide lines. Then it increased again from  2011 to 2013. For all the credit scores Income Range of $100,000+ has higher median of Net principal Loss.


### Plot Two
```{r echo=FALSE, Plot_Two}

# Scatter plot of CreditScoreRangeUpper vs CurrentDelinquencies
# facet wrap with EmploymentStatus

ggplot(data = subset(LoanData,LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies)), 
       aes(x = CreditScoreRangeUpper, y = CurrentDelinquencies, color = IncomeRange)) +
  geom_jitter(size=3) +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~ EmploymentStatus) +
  scale_color_brewer(type = 'div') +
  ggtitle("CreditScoreRangeUpper vs CurrentDelinquencies 
           faceted by EmploymentStatus\n")

# Density plot of CurrentDelinquencies

ggplot(data = subset(LoanData,
                     LoanData$CurrentDelinquencies > 0 & !is.na(CurrentDelinquencies)),
       aes(x=CurrentDelinquencies)) +
  geom_density(aes(group=CreditScoreRangeUpper,
                   color=CreditScoreRangeUpper),
               alpha=0.30) +
  scale_x_log10() +
  xlab('CurrentDelinquencies') +
  ylab('Density') +
  ggtitle('Density Plot of Delinquencies\n')

```

### Description Two

For all borrowers of various Income Ranges with Deliquencies, Credit Score range is between ~500-800. I can see there are many Deliquenicies for the Borrowers whose Employment Status is 'Employed' or 'Full-time' and Income Range varies. Also most of the Deliquencies > 50 belong to the Borrowers whose Employment Status is not specified or 'Not displayed' .'Not Employed' Borrowers have least Deliquencies. There are some Borrowers with Delinquencies whose credit score is way below 50. They belong to Employment Status not specified category. It would be interesting to know who they are.


### Plot Three
```{r echo=FALSE, Plot_Three}

# Scatter PLot of BorrowerRate vs LoanorignalAmount, 
# color by CreditScoreRangeUpper
# and faceted with year. Limited the CreditScoreRangeUpper from 600 to 850 
# to show the colors clearly. Used suppressWarnings and print to suppress
# the warnings generated by the plot.

p3 <- ggplot(data = LoanData, 
       aes(x = BorrowerRate,
           y = LoanOriginalAmount)) +
  geom_jitter(alpha=0.5,aes(color = CreditScoreRangeUpper),
              size=2) +
  scale_x_continuous(breaks = seq(0.0,0.3, 0.1),limits = c(0.0,0.3)) +
  scale_color_gradient(limits=c(600,850),high="green",low="blue") +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~ Year) +
  xlab("Borrower Rate") +
  ylab("Loan Amount") +
  ggtitle("Loan Amount vs Borrower Rate by Credit Score each year\n")

suppressWarnings(print(p3))

```

### Description Three

Borrowers with high Upper Range Creditscore are in the left of the plot and they generally have low interest rates. From 2010 to 2014 we can see Low Upper Range credit score borrowers have high interest rates. I think this is because of making the guide lines strict in 2009.

------

# Reflection

Prosper Loan Data set contains information about ~114,000 lOans issues to all kinds of borrowers from 2006 to 2014. It has 81 variables out of which I have chosen 21 variables to explore the data. It took some time to understand the varibales and select the from the list of 81 for futher exploration. I had to spend time to understand how Prosper works so that it will be easy for me to explore the varibles I have chosen.

From my analysis it seems like Propser struggled in the intial years until 2008 with many deliquencies, no strict rules etc. As we can see there was no proper information like Income Range, Employment Status about the borrowers. In 2009 once Prosper was restructured and made the rules stricter, I can see the deliquencies dropped significantly.

I would like to explore more on how Interest and fees are varying among different Loans, how the loans are distributed accross different states. Also I want to learn more about the models and create more models on this data using the other features in the data for example model loans likely to be deliquent based on credit scores.

# References

- Common function in R: http://discussions.udacity.com/t/common-function-in-r/10404/2
- Reshape: http://www.statmethods.net/management/reshape.html
- Date Formats in R: http://www.r-bloggers.com/date-formats-in-r/
- Do more with dates and times in R with lubridate: http://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html
- Introduction of dplyr: dplyr Tutorial Part 1 : http://www.r-bloggers.com/hadley-wickhams-dplyr-tutorial-at-user-2014-part-1/
- Types of smoothers in ggplot2: http://www.ats.ucla.edu/stat/r/faq/smooths.htm
- An Introduction to reshape2 by Sean Anderson: http://seananderson.ca/2013/10/19/reshape.html
- Converting Between Long and Wide Format: http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/
- Melt Data Frames: http://www.r-bloggers.com/melt/
- Cut Function: http://www.r-bloggers.com/r-function-of-the-day-cut-2/
- Bayesian Statistics and Marketing: http://www.perossi.org/home/bsm-1
- QuickR's Graphical Parameters: http://www.statmethods.net/advgraphs/parameters.html
- facet_wrap: http://docs.ggplot2.org/0.9.3.1/facet_wrap.html
- Log Transformations: http://www.r-statistics.com/2013/05/log-transformations-for-skewed-and-wide-distributions-from-practical-data-science-with-r/
- Basic Structure of a Function: https://www.youtube.com/watch?v=Z1wB1rHAYzQ&list=PLOU2XLYxmsIK9qQfztXeybpHvru-TrqAP
- Defining a New Transformation in ggplot2 and the Scales Package: http://blog.ggplot2.org/post/25938265813/defining-a-new-transformation-for-ggplot2-scales
- ggplot2: axis manipulation and themes: http://rstudio-pubs-static.s3.amazonaws.com/3364_d1a578f521174152b46b19d0c83cbe7e.html
- An Introduction to corrplot package: http://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html
- R Sub function: http://www.endmemo.com/program/R/sub.php
- ggplot2 - colors: http://docs.ggplot2.org/0.9.3.1/scale_gradient.html
- Beautiful plotting in R: A ggplot2 cheatsheet: http://zevross.com/blog/2014/08/04/beautiful-plotting-in-r-a-ggplot2-cheatsheet-3/
- Prosper: https://www.prosper.com/invest/marketplace-performance/
- Prosper: http://en.wikipedia.org/wiki/Prosper_Marketplace
- Prosper Ratings: https://www.prosper.com/invest/how-to-invest/prosper-ratings/
- Prosper: How it works: https://www.prosper.com/welcome/how-it-works/
